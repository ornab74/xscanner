name: Lock requirements + PQ-sign lock manifest (no wheelhouse)

on:
  workflow_dispatch:
  push:
    paths:
      - requirements.in
      - .github/workflows/lock-and-pq-sign-lockfile.yml

jobs:
  lock_and_pq_sign:
    runs-on: ubuntu-latest

    container:
      image: python:3.12-slim

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install system tools
        run: |
          set -euo pipefail
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates curl coreutils \
            cmake ninja-build build-essential pkg-config git
          rm -rf /var/lib/apt/lists/*

      - name: Upgrade pip + install pip-tools
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install pip-tools

      - name: Generate hash-locked requirements.txt
        run: |
          set -euo pipefail
          pip-compile \
            --generate-hashes \
            --resolver=backtracking \
            --output-file requirements.txt \
            requirements.in

      - name: Build + install liboqs
        run: |
          set -euo pipefail
          LIBOQS_VERSION="0.14.0"
          LIBOQS_URL="https://github.com/open-quantum-safe/liboqs/archive/refs/tags/${LIBOQS_VERSION}.tar.gz"

          curl -fsSL -o /tmp/liboqs.tar.gz "${LIBOQS_URL}"
          LIBOQS_SHA256="$(sha256sum /tmp/liboqs.tar.gz | awk '{print $1}')"

          echo "LIBOQS_VERSION=${LIBOQS_VERSION}" >> "$GITHUB_ENV"
          echo "LIBOQS_URL=${LIBOQS_URL}" >> "$GITHUB_ENV"
          echo "LIBOQS_SHA256=${LIBOQS_SHA256}" >> "$GITHUB_ENV"

          mkdir -p /tmp/liboqs-src
          tar -xzf /tmp/liboqs.tar.gz -C /tmp/liboqs-src --strip-components=1

          cmake -S /tmp/liboqs-src -B /tmp/liboqs-src/build \
            -DCMAKE_INSTALL_PREFIX=/usr/local \
            -DBUILD_SHARED_LIBS=ON \
            -DOQS_USE_OPENSSL=OFF \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -G Ninja

          cmake --build /tmp/liboqs-src/build --parallel
          cmake --install /tmp/liboqs-src/build
          ldconfig

          rm -rf /tmp/liboqs-src /tmp/liboqs.tar.gz

      - name: Install liboqs-python (oqs module)
        run: |
          set -euo pipefail
          pip install "liboqs-python==0.14.1"
          python -c "import oqs; print('oqs ready')"

      - name: Prepend provenance header into requirements.txt (BEFORE hashing/signing)
        run: |
          set -euo pipefail
          {
            echo "# liboqs_version=${LIBOQS_VERSION}"
            echo "# liboqs_tarball_sha256=${LIBOQS_SHA256}"
            echo "# liboqs_tarball_url=${LIBOQS_URL}"
            echo "# pq_signature_alg=Dilithium2"
            echo "# pq_manifest=lock.manifest.json"
            echo "# pq_signature=lock.manifest.pqsig"
            echo "# pq_pubkey=pq_pubkey.b64"
            echo "# generated_by=github_actions_lock_and_pq_sign_lockfile"
            echo
            cat requirements.txt
          } > requirements.tmp
          mv requirements.tmp requirements.txt

      - name: Create canonical lock manifest + PQ-sign it (Dilithium2)
        run: |
          set -euo pipefail

          # IMPORTANT: heredoc terminator must be seen by bash reliably.
          cat > /tmp/pq_sign_lock.py <<'PY'
          import base64, hashlib, json, os, re, sys
          import oqs

          ALG = "Dilithium2"
          REQ_PATH = "requirements.txt"

          if not os.path.exists(REQ_PATH):
              print("missing requirements.txt", file=sys.stderr)
              sys.exit(2)

          raw = open(REQ_PATH, "rb").read()
          req_sha256 = hashlib.sha256(raw).hexdigest()

          text = raw.decode("utf-8", errors="replace").splitlines()
          pkg_re = re.compile(r"^([A-Za-z0-9_.-]+)==([^\s\\]+)")
          pinned = []
          for line in text:
              m = pkg_re.match(line.strip())
              if m:
                  pinned.append({"name": m.group(1).lower(), "version": m.group(2)})
          pinned.sort(key=lambda x: x["name"])

          manifest_obj = {
              "format": "pq-lock-manifest-v1",
              "pq_alg": ALG,
              "requirements_txt_sha256": req_sha256,
              "pinned": pinned,
          }

          canonical = json.dumps(manifest_obj, sort_keys=True, separators=(",", ":")).encode("utf-8")

          with oqs.Signature(ALG) as s:
              pub = s.generate_keypair()
              sig = s.sign(canonical)

          open("lock.manifest.json", "wb").write(canonical + b"\n")
          open("lock.manifest.pqsig", "wb").write(sig)
          open("pq_pubkey.b64", "w", encoding="utf-8").write(base64.b64encode(pub).decode("ascii") + "\n")

          pub2 = base64.b64decode(open("pq_pubkey.b64", "r", encoding="utf-8").read().strip())
          with oqs.Signature(ALG) as v:
              ok = v.verify(canonical, sig, pub2)
          if not ok:
              print("PQ verify failed (self-check)", file=sys.stderr)
              sys.exit(3)

          print("OK: manifest PQ-signed and verified.")
          PY

          python /tmp/pq_sign_lock.py

          echo "Produced files:"
          ls -la requirements.txt lock.manifest.json lock.manifest.pqsig pq_pubkey.b64

      - name: Upload lock + PQ materials
        uses: actions/upload-artifact@v4
        with:
          name: pq-locked-requirements
          path: |
            requirements.txt
            lock.manifest.json
            lock.manifest.pqsig
            pq_pubkey.b64
          retention-days: 30
